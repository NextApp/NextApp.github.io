---

layout: post
title: 一个由并发导致的问题 
tags: [Bug]
image: 
   background: triangular.png
---

## 一个由并发导致的问题

### 问题由来
上周三我们公司的产品智能灯，由我们的客户，交给第三方进行评测，但说也很巧，在他第一次配网成功以后出现离线的现象，为此还写了一篇文章，发表在今日头条上。老板看到之后，很是生气。于是召集了我们大家对此进行测试和分析：测试了半天，就和我最初想像的一样，基本上是毫无进展，无法重现客户出现的问题。

### 问题在线
说也巧，临近十一放假还有半个小时，我在测试配网过程中，突然就出现了配网成功之后出现离线现象的问题。于是我立马找服务端调取了接口日志，查看设备配网过程中是否存在离线的情况。然而查出的接口日志赫然写着设备已上线。为什么会这样？客户端显示离线、服务端却显示在线？

### 设备在线机制
我们的设备在线状态主要是根据三种情况来判断的，一个是局域网在线离线情况A，一个是Mqtt长连接的在线离线情况B，还有一个是服务端和硬件那边的在线离线情况C.

```

设备online状态=A||(B&&C).
```

配网成功之后出现离线状态说明了，A和C、A和B、A和BC 同时出现离线状态。通过测试来看A不稳定，有一定的概率会出现离线情况。我配网成功之后，随即查看Mqtt在线状态，发现Mqtt连接正常，其他设备都可以控制，所以可以排除由于B导致的上述现象。但我也查询了最后一次接口日志，发现服务端返回的状态也是在线的。那为什么会出现，服务端返回在线，客户端又显示离线的问题呢？

### 结果分析
那天下午我反复查询了接口日志。发现了一个很奇怪的现象。客户端会调用两个不同的接口来查询这个设备的在线情况。一个是单个设备配网过程查询在线状态的接口。另一个是设备列表刷新设备状态的接口。这两个接口的共同点是都会更新本地在线状态信息。而且我发现这两个接口调用时间都是在同一秒内发生的:设备列表的接口返回结果在线状态是离线，单个设备状态查询接口是在线，虽然最后一次接口日志显示的是设备已在线，但设备列表的接口显示设备已离线，客户端在处理的时候，会有先后顺序把这个状态写入缓存。那么我们问题的原因，现在已经明了了。

### 前因后果
由于配网过程中调用了设备列表的接口导致出现同步问题，客户端显示设备离线。
